tinymce.PluginManager.add("b2evo_shorttags",function(a){function b(b){var d=a.dom;if(b!==q){if(a.getBody().focus(),c(),q=b,r=b.getAttribute("data-evo-type"),d.bind(q,"paste cut",e),d.addClass(q,"evo_selected"),d.bind(q,"beforedeactivate focusin focusout",e),d.is(q,"img"))a.selection.select(q);else{var f=d.select("img:first",q);f.length?a.selection.select(f[0]):a.selection.setCursorLocation(q)}a.nodeChanged()}}function c(){var b=a.dom;q&&(b.unbind(q,"paste cut beforedeactive focusin focusout"),b.removeClass(q,"evo_selected"),q=null,r=null,a.selection.collapse())}function d(b){q==b&&c(),a.undoManager.transact(function(){a.dom.remove(b)})}function e(a){return a.stopPropagation(),!1}function f(b,c){for(var d=[],e=0;e<b.length;e++){var f=g(b[e]);f===!1&&(s.push({shortTag:b[e],html:null,node:null,type:null,rendered:!1}),d.push("tags[]="+encodeURI(b[e])))}d.length?(d=d.join("&"),tinymce.util.XHR.send({url:a.getParam("anon_async_url")+"?action=render_inlines&p="+a.getParam("postID"),content_type:"application/x-www-form-urlencoded",data:d,success:function(b){var d=tinymce.util.JSON.parse(b);for(tag in d){var e=a.dom.create("div"),f=a.dom.createFragment(d[tag]),h=o(tag);a.dom.setAttrib(f.childNodes[0],"data-evo-tag",window.encodeURIComponent(tag)),a.dom.setAttrib(f.childNodes[0],"data-evo-type",h.type),e.appendChild(f);var i=g(tag);i===!1?s.push({shortTag:tag,html:e.innerHTML,node:e.childNodes[0],type:tagdata.type,rendered:!0}):i.rendered===!1&&(i.html=e.innerHTML,i.node=e.childNodes[0],i.rendered=!0)}c(d)}})):c()}function g(a){for(var b=s.length,c=0;b>c;c++)if(s[c].shortTag==a)return s[c];return!1}function h(a){for(var b,c=/(<span.*?data-evo-tag.*?>)?(\[(image|thumbnail|inline|video|audio):(\d+):?([^\[\]]*)\])(<\/span>)?/gi,d=[],e=[];null!==(b=c.exec(a));)b.index===c.lastIndex&&c.lastIndex++,d.push({shortTag:b[2],inlineType:b[3],linkId:parseInt(b[4]),other:b[5],openTag:b[1],closeTag:b[6]}),e.push(b[2]);f(e,function(a){a&&j()});for(var h=d.length,i=0;h>i;i++)if(d[i]&&!d[i].openTag&&!d[i].closeTag){var k=d[i].shortTag,l=g(k);if(l!==!1&&l.rendered!==!1)switch(d[i].inlineType){case"image":case"thumbnail":case"inline":a=a.replace(k,l.html);break;default:a=a.replace(k,'<span style="color: green;" data-evo-tag>'+k+"</span>")}}return a}function i(b){b=b.replace(/(<span [^>]+data-evo-error[^>]+>(.*?)<\/span>)/gi,function(a,b,c){return c});for(var c=/(<span.*?data-evo-tag.*?>)?(\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\])(<\/span>)?/gi;null!==(m=c.exec(b));)m.index===c.lastIndex&&c.lastIndex++,m[1]&&m[6]&&(b=b.replace(m[0],m[2]));for(var d,e=a.dom.createFragment(b);d=e.querySelector("[data-evo-tag]");){var f=window.decodeURIComponent(d.getAttributeNode("data-evo-tag").value);d.parentNode.replaceChild(document.createTextNode(f),d)}var g=a.dom.create("div");return g.appendChild(e),g.innerHTML}function j(){console.log("Update called");var b=a.getContent();a.setContent(h(b))}function k(b,c){return c||(c="data-evo-tag"),a.dom.getParent(b,"["+c+"]")}function l(a){var b=a.getAttribute("data-evo-tag");return b?o(b):!1}function n(a){return a.getAttribute("data-evo-tag")}function o(a){if(a){a=window.decodeURIComponent(a);var b=/\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\]/i,c=b.exec(a),d={tag:c[0],type:c[1],linkId:parseInt(c[2])};switch(d.type){case"image":var e=c[3];e?(e=e.split(":"),e[0]?"-"==e[0]?(d.caption=null,d.disableCaption=!0):(d.caption=e[0],d.disableCaption=!1):(d.caption=null,d.disableCaption=!1),e[1]?d.extraClass=e[1]:d.extraClass=null):(d.caption=null,d.extraClass=null);break;case"thumbnail":var e=c[3];e?(e=e.split(":"),e[0]&&-1!=["small","medium","large"].indexOf(e[0])?d.size=e[0]:d.size="medium",e[1]&&-1!=["left","right"].indexOf(e[1])?d.alignment=e[1]:d.alignment="left",e[2]?d.extraClass=e[2]:d.extraClass=null):(d.size="medium",d.alignment="left",d.extraClass=null);break;case"inline":var e=c[3];e?d.extraClass=e:d.extraClass=null;break;default:d.options=c[3]}return d}return!1}var p,q,r,s=[],t=!1,u=[];u.push(16,17,18,19),u.push(20,27,45),u.push(33,34,35,36),u.push(37,38,39,40),u.push(91,92,93),u.push(112,113,114,115,116,117,118,119,120,121,122,123),u.push(144,145);var v=this;v.selected=function(){return q},a.addButton("evo_image",{text:"[image:]",icon:!1,tooltip:"Edit image",onclick:function(){if(!a.getParam("postID"))return alert("Please save post first to start uploading files."),!1;if(!q||"image"!=r){return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:a.getParam("modal_url"),success:function(a){openModalWindow(a,"90%","80%",!0,"Select image","")}}),!1}var b=n(q);evo_item_image_edit(a.settings.blog_ID,b)},onPostRender:function(){var b=this;a.on("NodeChange",function(a){b.active("image"==r)})}}),a.addButton("evo_thumbnail",{text:"[thumbnail:]",icon:!1,tooltip:"Edit thumbnail",onclick:function(){if(!a.getParam("postID"))return alert("Please save post first to start uploading files."),!1;if(!q||"thumbnail"!=r)return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:a.getParam("modal_url"),success:function(a){openModalWindow(a,"90%","80%",!0,"Select image","")}}),!1;var b=l(q);p=a.windowManager.open({title:"Edit Thumbnail",body:[{type:"listbox",name:"alignment",label:"Alignment:",values:[{text:"left",value:"left"},{text:"right",value:"right"}],value:b?b.alignment:"left"},{type:"listbox",name:"size",label:"Size",values:[{text:"small",value:"small"},{text:"medium",value:"medium"},{text:"large",value:"large"}],value:b?b.size:"medium"},{type:"textbox",name:"extraClass",label:"Additional class:",minWidth:500,value:b?b.extraClass:null}],buttons:[{text:"Update",onclick:function(){var c=p.find("#size")[0],d=p.find("#alignment")[0],e=p.find("#extraClass")[0],h="[thumbnail:"+b.linkId;h+=":"+c.value(),h+=":"+d.value(),h+=e.value()?":"+e.value():"",h+="]";var i=g(h);i===!1?f([h],function(b){for(var c=0;c<s.length;c++)if(s[c].shortTag==h){i=s[c];break}i&&(q?a.dom.replace(i.node,q,!1):a.insertContent(i.html),a.windowManager.close())}):(q?a.dom.replace(i.node,q,!1):a.insertContent(i.html),a.windowManager.close())}},{text:"Cancel",onclick:"close"}]})},onPostRender:function(){var b=this;a.on("NodeChange",function(a){b.active("thumbnail"==r)})}}),a.addButton("evo_inline",{text:"[inline:]",icon:!1,tooltip:"Edit inline",onclick:function(){if(!a.getParam("postID"))return alert("Please save post first to start uploading files."),!1;if(!q||"inline"!=r)return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:a.getParam("modal_url"),success:function(a){openModalWindow(a,"90%","80%",!0,"Select image","")}}),!1;var b=l(q);p=a.windowManager.open({title:"Edit Inline",body:[{type:"textbox",name:"extraClass",label:"Additional class:",minWidth:500,value:b?b.extraClass:null}],buttons:[{text:"Update",onclick:function(){var c=p.find("#extraClass")[0],d="[inline:"+b.linkId;d+=c.value()?":"+c.value():"",d+="]";var e=g(d);e===!1?f([d],function(b){for(var c=0;c<s.length;c++)if(s[c].shortTag==d){e=s[c];break}e&&(q?a.dom.replace(e.node,q,!1):a.insertContent(e.html),a.windowManager.close())}):(q?a.dom.replace(e.node,q,!1):a.insertContent(e.html),a.windowManager.close())}},{text:"Cancel",onclick:"close"}]})},onPostRender:function(){var b=this;a.on("NodeChange",function(a){b.active("inline"==r)})}}),a.on("BeforeSetContent",function(a){console.log("BeforeSetContent:",a),a.content=h(a.content)}),a.on("PostProcess",function(a){a.get&&(a.content=i(a.content))}),a.on("attachmentsLoaded",function(a){console.log("Attachments Loaded"),j()}),a.on("mousedown mouseup click touchend",function(a){var d=k(a.target);d?(a.stopImmediatePropagation(),a.preventDefault(),b(d)):c()},!0),a.on("keydown",function(b){var c,d,e=(a.dom,a.selection);if(c=e.getNode(),d=k(c),q){if(8==b.which||46==b.which)return t=q,b.preventDefault(),!1;if(-1==u.indexOf(b.which))return b.preventDefault(),!1;switch(b.which){case 37:case 38:d.previousSibling&&e.setCursorLocation(q);break;case 39:case 40:if(d.nextSibling)return e.setCursorLocation(d.nextSibling),b.preventDefault(),!1}}else e.isCollapsed()||(range=e.getRng(),(d=k(range.endContainer))?(clonedRange=range.cloneRange(),e.select(d.previousSibling,!0),e.collapse(),tempRange=e.getRng(),clonedRange.setEnd(tempRange.endContainer,tempRange.endOffset),e.setRng(clonedRange)):(d=k(range.startContainer))&&(clonedRange=range.cloneRange(),clonedRange.setStart(d.nextSibling,0),e.setRng(clonedRange)))},!0),a.on("keyup",function(e){var f,g,h=(a.dom,a.selection);f=h.getNode(),g=k(f),g?b(g):c(),t&&(d(t),t=!1)}),a.on("ResolveName",function(b){if(a.dom.getAttrib(b.target,"data-evo-tag")){var c=a.dom.getAttrib(b.target,"data-evo-type");c?b.name="["+c+":]":b.name="shorttag",b.stopPropagation()}else k(b.target)&&(b.preventDefault(),b.stopPropagation())}),a.on("dragstart",function(a){var d=k(a.target);if(d){b(d);var e=window.decodeURIComponent(d.getAttribute("data-evo-tag"));a.dataTransfer.setData("application/x-moz-node",a.target),a.dataTransfer.setData("text/plain",e),a.dataTransfer.effectAllowed="move"}else c()}),a.on("drop",function(b){var c=b.target,d=b.dataTransfer.getData("text/plain"),e=k(c);return e&&(c=e),"BODY"==c.tagName?(b.preventDefault(),!1):e&&d&&q?(b.preventDefault(),c.insertAdjacentHTML("beforebegin",d),a.dom.remove(q),j(),!1):void 0}),a.on("init",function(){var b=a.selection;a.on("BeforeSetContent",function(){var c,d,e=k(b.getNode());e&&(!e.nextSibling||k(e.nextSibling)?(d=a.getDoc().createTextNode(""),a.dom.insertAfter(d,e)):(c=new tinymce.dom.TreeWalker(e.nextSibling,e.nextSibling),d=c.next()),b.select(d),b.collapse(!0))})})});