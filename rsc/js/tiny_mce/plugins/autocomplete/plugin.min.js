(function(){function o(e){return e.options==null&&typeof e!="boolean"?e.split(","):e.options}var e={};var t=40;var n=38;var r=27;var i=13;var s=[32,59,186,188,190];tinymce.create("tinymce.plugins.AutoCompletePlugin",{setOptions:function(t){e.options=o(t)},getOptions:function(){return e.options},init:function(u,a){function l(s){if(!e.visible&&s.keyCode!=r&&s.keyCode!=i||s.keyCode!=t&&s.keyCode!=n&&s.keyCode!=i&&s.keyCode!=r){var o=C(u);o=o.replace(e.trigger,"");var a=T(o);if(o.length>0){c(o)}if(o.length==0||a.length==0){y()}}}function c(t){var n=t.replace(e.trigger,"");if(t.length>=e.minLength&&(t.length<e.minLengthAjax||!e.optionsUrl)){matches=T(n);if(matches.length>0){v(matches,n,u);b()}}else{if(n.length<=1)return false;var r=e.options;jQuery.ajax({type:"POST",dataType:"JSON",url:e.optionsUrl,cache:false,data:"q="+n,success:function(t){if(t){var i=[];for(var s in t){i.push(t[s])}e.options=i;matches=T(n);if(matches.length>0){v(matches,n,u);b()}e.options=r}}});e.options=r}}function h(t){if(t.keyCode==i&&e.cancelEnter){e.cancelEnter=false;return tinymce.dom.Event.cancel(t)}}function p(o){if(e.visible){if(o.keyCode==t){b();return tinymce.dom.Event.cancel(o)}if(o.keyCode==n){w();return tinymce.dom.Event.cancel(o)}if(o.keyCode==i){E(u,C(u));e.cancelEnter=true;return false}if(o.keyCode==r){y();return tinymce.dom.Event.cancel(o)}if(e.onMatch&&s.indexOf(o.keyCode)){var a=C(u);var l=T(a);var c=new RegExp("^"+l[0]+"$","i");if(l.length==1&&a.match(c)){f.onMatch.dispatch(u,l[0])}}}}function d(e){y()}function v(t,n,r){var i="";var s=new RegExp("("+n+")");for(var o in t){if(t[o].key!=null){i+="<li data-value='"+t[o].key+"'>"+t[o].key.replace(s,"<mark>$1</mark>")+" "+t[o].description+"</li>"}else if(typeof t[o]=="string"){i+="<li data-value='"+t[o]+"'>"+t[o].replace(s,"<mark>$1</mark>")+"</li>"}}jQuery(e.list).html(i);var u=jQuery(r.getContainer()).find("iframe").offset();var a=0;var f=0;if(r.selection.getRng().getClientRects().length>0){a=r.selection.getRng().getClientRects()[0].top+r.selection.getRng().getClientRects()[0].height;f=r.selection.getRng().getClientRects()[0].left}else{a=parseInt(jQuery(r.selection.getNode()).css("font-size"))*1.3+nodePosition.top;f=nodePosition.left}jQuery(e.list).css("position","absolute");jQuery(e.list).css("top",u.top+a);jQuery(e.list).css("left",u.left+f);jQuery(e.list).css("display","block");e.visible=true;m(r)}function m(t){jQuery(e.list).find("li").hover(function(){jQuery(e.list).find("[data-selected=true]").attr("data-selected","false").removeClass("active");jQuery(this).attr("data-selected","true").addClass("active")});jQuery(e.list).find("li").click(function(){E(t,C(t))})}function g(){var e=document.createElement("ul");jQuery(e).addClass("textcomplete-list");document.body.appendChild(e);return e}function y(){jQuery(e.list).css("display","none");e.visible=false}function b(){var t=jQuery(e.list).find("[data-selected=true]");if(t.size()==0||t.next().size()==0){jQuery(e.list).find("li:first-child").attr("data-selected","true").addClass("active")}else{t.next().attr("data-selected","true").addClass("active")}t.attr("data-selected","false").removeClass("active")}function w(){var t=jQuery(e.list).find("[data-selected=true]");if(t.size()==0||t.prev().size()==0){jQuery(e.list).find("li:last-child").attr("data-selected","true").addClass("active")}else{t.prev().attr("data-selected","true").addClass("active")}t.attr("data-selected","false").removeClass("active")}function E(t,n){var r=jQuery(e.list).find("[data-selected=true]").attr("data-value");if(r==null){r=jQuery(e.list).find("li:first-child").attr("data-value")}var i=x(t.selection.getSel().anchorNode,"");var s=t.selection.getSel().anchorNode.textContent;var o=t.selection.getRng();o.setStart(o.startContainer,o.startOffset-n.length);t.selection.setRng(o);var u="";if(e.delimiter.length>0){u=String.fromCharCode(e.delimiter[0])}t.selection.setContent(e.trigger+r.toString()+u);if(e.enclosing.length>0&&!S(i,s)){var a=t.selection.getBookmark();t.selection.setContent(u+e.trigger+e.enclosing);t.selection.moveToBookmark(a)}y();if(e.onSelect){f.onSelect.dispatch(t,r)}y()}function S(t,n){var r=e.trigger+e.enclosing;t=t.substr(n.length);var i=(new RegExp(e.trigger+".{"+e.enclosing.length+"}","g")).exec(t);if(i!=null&&i.length>0&&i[0]==r){return true}return false}function x(e,t){t+=e.textContent;if(e.nextSibling!=null){return x(e.nextSibling,t)}return t}function T(t){var n=e.options;var r=[];for(var i in n){if(n[i].key==null&&(t.length==0||N(t,n[i]))){r.push(n[i])}else if(n[i].key!=null&&(t.length==0||N(t,n[i].key))){r.push(n[i])}}return r}function N(e,t){var n=new RegExp("^"+e,"i");return typeof t=="string"?t.match(n):""}function C(t){var n=t.selection.getSel().focusNode==null?"":t.selection.getSel().focusNode.nodeValue;var r=t.selection.getSel().focusOffset;if(n==null||n.length==0){return""}var i=0;for(var s=0;s<r;s++){if(e.delimiter.indexOf(n.charCodeAt(s).toString())!=-1){i=s+1}}var o=n.substr(i,r-i);var u="";if(e.trigger==""){if(o.length>=e.minLength){u=o}}else{if(o.length>e.minLength&&o.charAt(0).toString()==e.trigger){u=o}}return u}e={list:g(),visible:false,cancelEnter:false,delimiter:u.getParam("autocomplete_delimiters","160,32").split(","),options:o(u.getParam("autocomplete_options","")),optionsUrl:o(u.getParam("autocomplete_options_url",false)),trigger:u.getParam("autocomplete_trigger","@"),enclosing:u.getParam("autocomplete_end_option",""),minLength:u.getParam("autocomplete_min_length","1"),minLengthAjax:u.getParam("autocomplete_min_length_ajax","4"),onSelect:u.getParam("autocomplete_on_select",false),onMatch:u.getParam("autocomplete_on_match",false)};var f=this;if(e.onSelect){f.onSelect=new tinymce.util.Dispatcher(f);f.onSelect.add(function(e,t){e.execCallback("autocomplete_on_select",e,t)})}if(e.onMatch){f.onMatch=new tinymce.util.Dispatcher(f);f.onMatch.add(function(e,t){e.execCallback("autocomplete_on_match",e,t)})}u.on("keyup",l);u.on("keydown",p);u.on("keypress",h);u.on("click",d)},getInfo:function(){return{longname:"AutoComplete",author:"Mijura Pty Ltd",authorurl:"http://mijura.com",infourl:"http://blog.mijura.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("autocomplete",tinymce.plugins.AutoCompletePlugin)})()